{% extends 'layout.twig' %}

{% block body %}
  <div class="container mt-4">
    <h1>Welcome to Ronin.Rest</h1>
    <p class="alert alert-info">
      ronin.rest is a REST API built by wehmoen#0001 and allows easy access to the Ronin chain and Origin game data.
      <br>
      ronin.rest is not affiliated with Sky Mavis!
    </p>

    <h2>Available Tools</h2>

   <div class="row">
     <div class="col-12 col-md-3">
       <div class="card">
         <div class="card-body">
           <h5 class="card-title">
             Axie Sales
           </h5>
           Easy to use marketplace sale history for all Axies.
         </div>
         <div class="card-footer">
           <a href="/sales" class="btn btn-sm w-100 btn-primary">GO!</a>
         </div>
       </div>
     </div>
     <div class="col-12 col-md-3">
       <div class="card">
         <div class="card-body">
           <h5 class="card-title">
             Axie Transfers
           </h5>
           A comprehensive log of all transfers for all Axies!
         </div>
         <div class="card-footer">
           <a href="/transfers" class="btn btn-sm w-100 btn-primary">GO!</a>
         </div>
       </div>
     </div>
     <div class="col-12 col-md-6">
       <div class="card">
         <div class="card-body">
           <h5 class="card-title">
            Donations
           </h5>
           Do you like Ronin.Rest and want to support me? I am grateful for any donations send to:
           <code>
             ronin:769ff23c2a296a769e7825b92d21d5f1ab453550
           </code>
           <div>Alternatively you can use my Lunacian code: <code>LX7LKNAF</code></div>
         </div>
         <div class="card-footer">
           Cheers! ~ wehmoen#0001
         </div>
       </div>
     </div>
     <div class="col-12 mt-3">
       <div class="card">
         <div class="card-body">
           <h5 class="card-title">
            Are you a developer?
           </h5>
           Check out all available API endpoints at <a href="https://ronin.rest" target="_blank">https://ronin.rest</a>
         </div>
       </div>
     </div>
   </div>
    <div class="row">
      <div class="col-12">
        <hr>
        <h2>Service Health</h2>
      </div>
    </div>
    <div class="row" id="health_info"></div>
    <div class="row mt-2" id="pgbs"></div>
  </div>
{% endblock %}
{% block script %}
<script>
  window.onload = async function() {
    const service_health = await (await fetch("https://ronin.rest/misc/health")).json()
    function health_container(name, healthy) {
      const col = document.createElement("div");
      col.classList.add("col");
      col.classList.add("mt-2");
      const con = document.createElement("div");
      con.classList.add(`bg-${healthy ? 'success': 'danger'}`);
      con.classList.add("card")
      const body = document.createElement("div")
      body.classList.add("card-body")
      body.classList.add("text-center")
      const title = document.createElement("h4")
      title.classList.add("card-title")
      title.innerText = name;
      const content = document.createElement("span")
      content.innerText = healthy ? "UP!": "DOWN!";
      content.classList.add("text-white")
      content.classList.add("fw-bold")
      content.classList.add("fs-3")
      body.appendChild(title)
      body.appendChild(content)
      con.appendChild(body)
      col.appendChild(con)
      document.getElementById("health_info").appendChild(col)
    }

    for (const h in service_health) {
      if (h !== "sync") {
        health_container(h, service_health[h].healthy)
      }
    }

    function createProgressBar(label, current, max) {

      const progress = current / max * 100;
      const progress_fmt = progress.toFixed(2) + "%"

      const color = progress <= 99.9 ? "bg-warning" : "bg-success"
      const type = max -current > 50 ? "progress-bar-striped progress-bar-animated" : ""


      return ` <div class="col-12 mt-4">
                <h5>${label}</h5>
                <div data-progress="${progress}" class="progress" style="height: 20px">
                  <div class="progress-bar ${type} ${color} " role="progressbar" aria-label="Info striped example" style="width: ${progress}%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
    <b>${current} / ${max} (${progress_fmt})</b>
</div>
                </div>
              </div>`

    }

    let progress_old = service_health["sync"].old;
    let progress_new = service_health["sync"].new;

    const old_pgb = createProgressBar("Services: transactions, axie-transfers, erc-transfer, axie-sales-v1", progress_old.db, progress_old.chain)
    const new_pgb = createProgressBar("Services: ronin.rest V2", progress_new.db, progress_new.chain)

    document.getElementById("pgbs").innerHTML = old_pgb + new_pgb


  }
</script>
{% endblock %}